<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telescope Park Bridge v0.3.0</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 40px; 
            background: #f5f5f5; 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        h1 { 
            color: #2c3e50; 
            border-bottom: 3px solid #3498db; 
            padding-bottom: 10px; 
        }
        
        /* Tab styling */
        .tab-container { 
            margin: 20px 0; 
        }
        
        .tab-buttons { 
            display: flex; 
            border-bottom: 2px solid #3498db; 
        }
        
        .tab-button { 
            background: #ecf0f1; 
            border: none; 
            padding: 12px 24px; 
            cursor: pointer; 
            font-size: 16px; 
            border-top-left-radius: 5px; 
            border-top-right-radius: 5px; 
            margin-right: 2px; 
        }
        
        .tab-button.active { 
            background: #3498db; 
            color: white; 
        }
        
        .tab-button:hover { 
            background: #2980b9; 
            color: white; 
        }
        
        .tab-content { 
            display: none; 
            padding: 20px 0; 
        }
        
        .tab-content.active { 
            display: block; 
        }
        
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
        }
        
        .connected { 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            color: #155724; 
        }
        
        .disconnected { 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
            color: #721c24; 
        }
        
        .safe { 
            background: #d1ecf1; 
            border: 1px solid #bee5eb; 
            color: #0c5460; 
        }
        
        .unsafe { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            color: #856404; 
        }
        
        .warning { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            color: #856404; 
        }
        
        .info-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin: 20px 0; 
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .info-box { 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 5px; 
            border-left: 4px solid #3498db; 
        }
        
        .info-box h3 { 
            margin-top: 0; 
            color: #2c3e50; 
        }
        
        .value { 
            font-weight: bold; 
            color: #27ae60; 
        }
        
        .control-panel { 
            background: #e9ecef; 
            padding: 20px; 
            border-radius: 5px; 
            margin: 20px 0; 
        }
        
        .control-panel h3 { 
            margin-top: 0; 
        }
        
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        
        button:hover { 
            background: #2980b9; 
        }
        
        button:disabled { 
            background: #95a5a6; 
            cursor: not-allowed; 
        }
        
        .btn-success { 
            background: #27ae60; 
        }
        
        .btn-success:hover { 
            background: #229954; 
        }
        
        .btn-danger { 
            background: #e74c3c; 
        }
        
        .btn-danger:hover { 
            background: #c0392b; 
        }
        
        .btn-warning { 
            background: #f39c12; 
        }
        
        .btn-warning:hover { 
            background: #e67e22; 
        }
        
        .btn-large { 
            padding: 15px 25px; 
            font-size: 16px; 
            margin: 10px 5px; 
        }
        
        select, input { 
            padding: 8px; 
            margin: 5px; 
            border: 1px solid #bdc3c7; 
            border-radius: 3px; 
        }
        
        .form-group { 
            margin: 10px 0; 
        }
        
        .form-group label { 
            display: inline-block; 
            width: 120px; 
        }
        
        #log { 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 15px; 
            border-radius: 5px; 
            height: 200px; 
            overflow-y: scroll; 
            font-family: monospace; 
            font-size: 12px; 
            white-space: pre-wrap; 
        }
        
        .command-interface {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #f39c12;
        }
        
        .command-input {
            width: 200px;
        }
        
        .command-response {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            min-height: 40px;
        }
        
        .endpoints { 
            background: #e9ecef; 
            padding: 20px; 
            border-radius: 5px; 
            margin: 20px 0; 
        }
        
        .endpoints h3 { 
            margin-top: 0; 
        }
        
        .endpoint { 
            font-family: monospace; 
            background: white; 
            padding: 8px; 
            margin: 5px 0; 
            border-radius: 3px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî≠ Telescope Park Bridge v0.3.0</h1>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('park-sensor')">üõ°Ô∏è Park Sensor</button>
                <button class="tab-button" onclick="switchTab('commands')">‚öôÔ∏è Device Commands</button>
                <button class="tab-button" onclick="switchTab('logs')">üìã Activity Logs</button>
            </div>
            
            <!-- Park Sensor Tab -->
            <div id="park-sensor" class="tab-content active">
                <div id="connection-status" class="status disconnected">
                    ‚ö†Ô∏è Checking connection...
                </div>
                
                <div id="safety-status" class="status unsafe">
                    üö´ Safety status unknown
                </div>
                
                <div class="control-panel">
                    <h3>Serial Port Control</h3>
                    <div class="form-group">
                        <label for="port-select">Port:</label>
                        <select id="port-select">
                            <option value="">Loading ports...</option>
                        </select>
                        <button onclick="refreshPorts()">üîÑ Refresh</button>
                    </div>
                    <div class="form-group">
                        <label for="baud-rate">Baud Rate:</label>
                        <input type="number" id="baud-rate" value="115200" min="9600" max="921600">
                    </div>
                    <div class="form-group">
                        <button id="connect-btn" class="btn-success" onclick="connectToPort()">üîå Connect</button>
                        <button id="disconnect-btn" class="btn-danger" onclick="disconnectFromPort()" disabled>‚ùå Disconnect</button>
                    </div>
                </div>
                
                <div class="info-grid">
                    <div class="info-box">
                        <h3>Device Information</h3>
                        <p><strong>Name:</strong> <span id="device-name">Loading...</span></p>
                        <p><strong>Version:</strong> <span id="device-version">Loading...</span></p>
                        <p><strong>Manufacturer:</strong> <span id="manufacturer">Loading...</span></p>
                        <p><strong>Serial Port:</strong> <span id="serial-port">Loading...</span></p>
                    </div>
                    
                    <div class="info-box">
                        <h3>Position Data</h3>
                        <p><strong>Current Pitch:</strong> <span id="current-pitch" class="value">--</span>¬∞</p>
                        <p><strong>Current Roll:</strong> <span id="current-roll" class="value">--</span>¬∞</p>
                        <p><strong>Park Pitch:</strong> <span id="park-pitch" class="value">--</span>¬∞</p>
                        <p><strong>Park Roll:</strong> <span id="park-roll" class="value">--</span>¬∞</p>
                        <p><strong>Tolerance:</strong> <span id="tolerance" class="value">--</span>¬∞</p>
                    </div>
                </div>
            </div>
            
            <!-- Device Commands Tab -->
            <div id="commands" class="tab-content">
                <div class="control-panel">
                    <h3>Device Control</h3>
                    <div class="form-group">
                        <button id="set-park-btn" class="btn-warning btn-large" onclick="setParkPosition()" disabled>üìç Set Park Position</button>
                        <button id="calibrate-btn" class="btn-warning btn-large" onclick="calibrateSensor()" disabled>‚öñÔ∏è Calibrate Sensor</button>
                        <button id="factory-reset-btn" class="btn-danger btn-large" onclick="factoryReset()" disabled>üîÑ Factory Reset</button>
                    </div>
                </div>
                
                <div class="command-interface">
                    <h3>Manual Serial Commands</h3>
                    <p>Send commands directly to the device. Common commands:</p>
                    <ul>
                        <li><strong>&lt;01&gt;</strong> - Get device status</li>
                        <li><strong>&lt;02&gt;</strong> - Get current position</li>
                        <li><strong>&lt;03&gt;</strong> - Check if parked</li>
                        <li><strong>&lt;04&gt;</strong> - Set current position as park</li>
                        <li><strong>&lt;06&gt;</strong> - Calibrate sensor</li>
                        <li><strong>&lt;0E&gt;</strong> - Factory reset</li>
                    </ul>
                    
                    <div class="form-group">
                        <label for="manual-command">Command:</label>
                        <input type="text" id="manual-command" class="command-input" placeholder="<01>" maxlength="32">
                        <button id="send-command-btn" onclick="sendManualCommand()" disabled>üì§ Send</button>
                    </div>
                    
                    <div class="command-response" id="command-response">
                        Command responses will appear here...
                    </div>
                </div>
            </div>
            
            <!-- Activity Logs Tab -->
            <div id="logs" class="tab-content">
                <div class="endpoints">
                    <h3>ASCOM Alpaca Endpoints</h3>
                    <div class="endpoint">GET /api/v1/safetymonitor/0/connected</div>
                    <div class="endpoint">GET /api/v1/safetymonitor/0/issafe</div>
                    <div class="endpoint">GET /api/v1/safetymonitor/0/name</div>
                    <div class="endpoint">GET /api/v1/safetymonitor/0/description</div>
                </div>
                
                <div>
                    <button onclick="refreshStatus()">üîÑ Refresh Status</button>
                    <button onclick="testConnection()">üß™ Test ASCOM</button>
                    <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
                </div>
                
                <h3>Activity Log</h3>
                <div id="log"></div>
            </div>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let currentlyConnected = false;

        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Mark selected tab button as active
            event.target.classList.add('active');
            
            log('üìë Switched to ' + tabName + ' tab');
        }

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += '[' + timestamp + '] ' + message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            logElement.textContent = '';
        }

        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                log('‚ùå Failed to fetch status: ' + error.message);
            }
        }

        async function refreshPorts() {
            try {
                const response = await fetch('/api/ports');
                const data = await response.json();
                const select = document.getElementById('port-select');
                
                select.innerHTML = '<option value="">Select a port...</option>';
                
                data.ports.forEach(port => {
                    const option = document.createElement('option');
                    option.value = port.name;
                    option.textContent = port.name + ' - ' + port.description;
                    select.appendChild(option);
                });
                
                log('üîÑ Refreshed ' + data.ports.length + ' available ports');
            } catch (error) {
                log('‚ùå Failed to refresh ports: ' + error.message);
            }
        }

        async function connectToPort() {
            const port = document.getElementById('port-select').value;
            const baudRate = parseInt(document.getElementById('baud-rate').value);
            
            if (!port) {
                log('‚ùå Please select a port first');
                return;
            }
            
            try {
                const response = await fetch('/api/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port: port, baud_rate: baudRate })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ ' + data.message);
                } else {
                    log('‚ùå Connection failed: ' + data.message);
                }
            } catch (error) {
                log('‚ùå Failed to connect: ' + error.message);
            }
        }

        async function disconnectFromPort() {
            try {
                const response = await fetch('/api/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ ' + data.message);
                } else {
                    log('‚ùå Disconnect failed: ' + data.message);
                }
            } catch (error) {
                log('‚ùå Failed to disconnect: ' + error.message);
            }
        }

        async function setParkPosition() {
            try {
                const response = await fetch('/api/set_park', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('üìç ' + data.message);
                } else {
                    log('‚ùå Set park failed: ' + data.message);
                }
            } catch (error) {
                log('‚ùå Failed to set park position: ' + error.message);
            }
        }

        async function calibrateSensor() {
            try {
                const response = await fetch('/api/calibrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚öñÔ∏è ' + data.message);
                } else {
                    log('‚ùå Calibration failed: ' + data.message);
                }
            } catch (error) {
                log('‚ùå Failed to calibrate sensor: ' + error.message);
            }
        }

        async function factoryReset() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to perform a factory reset? This will erase all settings!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/factory_reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('üîÑ ' + data.message);
                } else {
                    log('‚ùå Factory reset failed: ' + data.message);
                }
            } catch (error) {
                log('‚ùå Failed to perform factory reset: ' + error.message);
            }
        }

        async function sendManualCommand() {
            const command = document.getElementById('manual-command').value.trim();
            const responseDiv = document.getElementById('command-response');
            
            if (!command) {
                responseDiv.textContent = 'Please enter a command';
                return;
            }
            
            try {
                const response = await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    responseDiv.textContent = 'Command: ' + data.command + '\nResponse: ' + (data.response || 'No response');
                    log('üì§ Manual command sent: ' + command);
                } else {
                    responseDiv.textContent = 'Error: ' + data.message;
                    log('‚ùå Manual command failed: ' + data.message);
                }
            } catch (error) {
                responseDiv.textContent = 'Network error: ' + error.message;
                log('‚ùå Failed to send command: ' + error.message);
            }
        }

        function updateConnectionButtons(connected) {
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const portSelect = document.getElementById('port-select');
            const baudRate = document.getElementById('baud-rate');
            const setParkBtn = document.getElementById('set-park-btn');
            const calibrateBtn = document.getElementById('calibrate-btn');
            const factoryResetBtn = document.getElementById('factory-reset-btn');
            const sendCommandBtn = document.getElementById('send-command-btn');
            
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            portSelect.disabled = connected;
            baudRate.disabled = connected;
            
            // Enable/disable device control buttons
            setParkBtn.disabled = !connected;
            calibrateBtn.disabled = !connected;
            factoryResetBtn.disabled = !connected;
            sendCommandBtn.disabled = !connected;
            
            currentlyConnected = connected;
        }

        function updateUI(data) {
            // Connection status
            const connStatus = document.getElementById('connection-status');
            if (data.connected) {
                connStatus.className = 'status connected';
                connStatus.innerHTML = '‚úÖ Connected to park sensor';
                updateConnectionButtons(true);
            } else {
                connStatus.className = 'status disconnected';
                connStatus.innerHTML = '‚ùå Not connected to park sensor';
                if (data.error_message) {
                    connStatus.innerHTML += ' - ' + data.error_message;
                }
                updateConnectionButtons(false);
            }
            
            // Safety status
            const safetyStatus = document.getElementById('safety-status');
            if (data.connected) {
                if (data.is_safe) {
                    safetyStatus.className = 'status safe';
                    safetyStatus.innerHTML = '‚úÖ Telescope is PARKED (Safe)';
                } else {
                    safetyStatus.className = 'status unsafe';
                    safetyStatus.innerHTML = '‚ö†Ô∏è Telescope is NOT PARKED (Unsafe)';
                }
            } else {
                safetyStatus.className = 'status unsafe';
                safetyStatus.innerHTML = 'üö´ Safety status unknown (disconnected)';
            }
            
            // Device info
            document.getElementById('device-name').textContent = data.device_name;
            document.getElementById('device-version').textContent = data.device_version;
            document.getElementById('manufacturer').textContent = data.manufacturer;
            document.getElementById('serial-port').textContent = data.serial_port || 'Not connected';
            
            // Position data
            document.getElementById('current-pitch').textContent = data.current_pitch.toFixed(2);
            document.getElementById('current-roll').textContent = data.current_roll.toFixed(2);
            document.getElementById('park-pitch').textContent = data.park_pitch.toFixed(2);
            document.getElementById('park-roll').textContent = data.park_roll.toFixed(2);
            document.getElementById('tolerance').textContent = data.position_tolerance.toFixed(1);
        }

        function refreshStatus() {
            log('üîÑ Refreshing status...');
            fetchStatus();
        }

        async function testConnection() {
            log('üß™ Testing ASCOM connection...');
            try {
                const response = await fetch('/api/v1/safetymonitor/0/connected');
                const data = await response.json();
                if (data.ErrorNumber === 0) {
                    log('‚úÖ ASCOM test successful - Connected: ' + data.Value);
                } else {
                    log('‚ùå ASCOM test failed - Error: ' + data.ErrorMessage);
                }
            } catch (error) {
                log('‚ùå ASCOM test failed: ' + error.message);
            }
        }

        // Enter key support for manual commands
        document.addEventListener('DOMContentLoaded', function() {
            const commandInput = document.getElementById('manual-command');
            commandInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendManualCommand();
                }
            });
        });

        // Auto-refresh every 5 seconds
        setInterval(fetchStatus, 5000);

        // Initial load
        log('üöÄ Web interface v0.3.0 loaded');
        fetchStatus();
        refreshPorts();